<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Prediction - AI Trading Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Chart.js for price chart visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Advanced Prediction Styles */
        .pred-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 20px;
        }
        
        .pred-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .pred-header h1 {
            color: #2563eb;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .pred-header p {
            color: #6b7280;
            font-size: 1.1em;
        }
        
        /* Control Panel */
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .control-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }
        
        .control-group select,
        .control-group input {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .mode-btn:hover {
            border-color: #2563eb;
        }
        
        .mode-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        
        /* Run Button */
        .run-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .run-btn:hover {
            transform: translateY(-2px);
        }
        
        .run-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Results Section */
        .results-section {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .result-card h2 {
            margin-bottom: 20px;
            color: #1f2937;
        }
        
        /* Signal Display */
        .signal-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .signal-item {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            background: #f3f4f6;
        }
        
        .signal-item.buy {
            background: #d1fae5;
            border: 2px solid #10b981;
        }
        
        .signal-item.sell {
            background: #fee2e2;
            border: 2px solid #ef4444;
        }
        
        .signal-item.hold {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }
        
        .signal-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .signal-label {
            color: #6b7280;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        
        /* Summary Card */
        .summary-card {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            font-size: 1.1em;
            line-height: 1.6;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
        }
        
        /* Prediction History */
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .history-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        .history-table tr:hover {
            background: #f9fafb;
        }
        
        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-ai {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-indicator {
            background: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <div style="background: white; border-bottom: 1px solid #e5e7eb; padding: 15px 20px; margin-bottom: 20px;">
        <div style="max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button onclick="window.location.href='/dashboard'" style="padding: 8px 16px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                    <span>‚Üê</span>
                    <span>Back to Dashboard</span>
                </button>
                <span style="color: #6b7280; font-size: 14px;">|</span>
                <span style="font-weight: 600; color: #2563eb; font-size: 16px;">üîÆ Advanced Prediction</span>
            </div>
            <div>
                <a href="/dashboard" style="color: #6b7280; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                    <span>üë§</span>
                    <span>{{ session.get('username', 'User') }}</span>
                </a>
            </div>
        </div>
    </div>

    <div class="pred-container">
        <!-- Header -->
        <div class="pred-header">
            <h1>üîÆ Advanced Crypto Prediction</h1>
            <p>AI-powered and indicator-based price forecasting with multi-source data analysis</p>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h3>Prediction Settings</h3>
            
            <!-- Symbol & Timeframe Selection -->
            <div class="control-row">
                <div class="control-group">
                    <label for="symbol">Symbol:</label>
                    <select id="symbol">
                        <option value="BTC/USDT">BTC/USDT</option>
                        <option value="ETH/USDT">ETH/USDT</option>
                        <option value="BNB/USDT">BNB/USDT</option>
                        <option value="SOL/USDT">SOL/USDT</option>
                        <option value="XRP/USDT">XRP/USDT</option>
                        <option value="ADA/USDT">ADA/USDT</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="timeframe">Timeframe:</label>
                    <select id="timeframe">
                        <option value="1h">1 Hour</option>
                        <option value="4h">4 Hours</option>
                        <option value="1d">1 Day</option>
                    </select>
                </div>
            </div>
            
            <!-- Mode Toggle -->
            <label>Prediction Mode:</label>
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="ai" onclick="selectMode('ai')">
                    ü§ñ AI Model
                </button>
                <button class="mode-btn" data-mode="indicator" onclick="selectMode('indicator')">
                    üìä Indicator Model
                </button>
            </div>
            
            <!-- Run Button -->
            <button class="run-btn" onclick="runPrediction()">
                ‚ñ∂Ô∏è Run Prediction
            </button>
        </div>

        <!-- Trade Execution Panel -->
        <div class="control-panel" style="margin-top: 20px; border: 2px solid #f59e0b; background: #fffbeb;">
            <h3 style="color: #92400e;">‚ö° Execute Trade Based on Prediction</h3>
            <p style="color: #78350f; font-size: 0.9em; margin-bottom: 15px;">
                <strong>‚ö†Ô∏è Safety Notice:</strong> This feature is in <strong>SIMULATION MODE</strong> by default. 
                No real money is at risk. All trades are logged but not sent to the exchange.
            </p>
            
            <div class="control-row">
                <div class="control-group">
                    <label for="advExchangeAccount">Exchange Account:</label>
                    <select id="advExchangeAccount">
                        <option value="">Select an exchange account...</option>
                    </select>
                    <small style="color: #6b7280; font-size: 0.85em;">
                        Select your linked exchange account (from Profile section)
                    </small>
                </div>
                
                <div class="control-group">
                    <label for="advAmountUsdt">Amount (USDT):</label>
                    <input type="number" id="advAmountUsdt" min="10" step="10" value="50" 
                           style="padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                    <small style="color: #6b7280; font-size: 0.85em;">
                        How much USDT to use for the trade
                    </small>
                </div>
            </div>
            
            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #f59e0b;">
                <strong style="color: #92400e;">üìã How it works:</strong>
                <ol style="margin: 10px 0 0 20px; color: #78350f; font-size: 0.9em; line-height: 1.8;">
                    <li>System runs prediction (AI or Indicator mode)</li>
                    <li>If signal is <strong>BUY</strong> or <strong>SELL</strong>, trade is executed</li>
                    <li>If signal is <strong>HOLD</strong>, no trade is executed</li>
                    <li>All trades are <strong>SIMULATED</strong> (config.LIVE_TRADING_ENABLED = False)</li>
                    <li>Execution result is displayed below</li>
                </ol>
            </div>
            
            <!-- Execute Button -->
            <button id="executeAdvancedTradeBtn" class="run-btn" 
                    style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); margin-top: 10px;">
                ‚ö° Execute Advanced Trade
            </button>
            
            <!-- Trade Result Display -->
            <div id="advancedTradeResult" style="margin-top: 20px;"></div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Running advanced prediction analysis...</p>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="results">
            <!-- Signal Display -->
            <div class="result-card">
                <h2>üìà Prediction Result</h2>
                <div class="signal-display" id="signalDisplay">
                    <!-- Dynamically populated -->
                </div>
                
                <!-- Summary -->
                <div class="summary-card" id="summary">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <!-- Price Chart -->
            <div class="result-card">
                <h2>üìâ Price Chart & Forecast</h2>
                <div class="chart-container">
                    <canvas id="predChart"></canvas>
                </div>
                <!-- TASK 41: EMA Legend -->
                <div style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
                    <strong style="color: #1e40af;">üìä EMA Trend Lines:</strong>
                    <span style="color: #10b981;">EMA 9</span> / 
                    <span style="color: #06b6d4;">EMA 20</span> / 
                    <span style="color: #f59e0b;">EMA 50</span> / 
                    <span style="color: #a855f7;">EMA 100</span> / 
                    <span style="color: #ec4899;">EMA 200</span>
                    <br>
                    <small style="color: #475569;">
                        EMAs (Exponential Moving Averages) respond faster than SMAs to price changes. 
                        When EMAs are aligned upward (9>20>50), it indicates a strong uptrend.
                    </small>
                </div>
            </div>

            <!-- Prediction History -->
            <div class="result-card">
                <h2>üìú Recent Predictions</h2>
                <table class="history-table" id="historyTable">
                    <!-- Dynamically populated -->
                </table>
            </div>
        </div>
    </div>

    <script>
        let selectedMode = 'ai';
        let currentChart = null;

        // ========================================
        // MODE SELECTION
        // ========================================
        function selectMode(mode) {
            selectedMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
        }

        // ========================================
        // RUN PREDICTION
        // ========================================
        async function runPrediction() {
            const symbol = document.getElementById('symbol').value;
            const timeframe = document.getElementById('timeframe').value;
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            // Disable button
            const btn = document.querySelector('.run-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Running...';
            
            try {
                const response = await fetch('/api/advanced_predict', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        symbol: symbol,
                        timeframe: timeframe,
                        mode: selectedMode
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data);
                    await loadHistory();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to run prediction: ' + error.message);
            } finally {
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
                // Enable button
                btn.disabled = false;
                btn.textContent = '‚ñ∂Ô∏è Run Prediction';
            }
        }

        // ========================================
        // DISPLAY RESULTS
        // ========================================
        function displayResults(data) {
            // Show results section
            document.getElementById('results').style.display = 'block';
            
            // Display signal
            const signalClass = data.signal.toLowerCase();
            const signalEmoji = data.signal === 'BUY' ? 'üü¢' : (data.signal === 'SELL' ? 'üî¥' : 'üü°');
            
            document.getElementById('signalDisplay').innerHTML = `
                <div class="signal-item ${signalClass}">
                    <div class="signal-label">Signal</div>
                    <div class="signal-value">${signalEmoji} ${data.signal}</div>
                </div>
                <div class="signal-item">
                    <div class="signal-label">Current Price</div>
                    <div class="signal-value">$${data.current_price.toLocaleString()}</div>
                </div>
                <div class="signal-item">
                    <div class="signal-label">Target Price</div>
                    <div class="signal-value">$${data.target_price.toLocaleString()}</div>
                </div>
                <div class="signal-item">
                    <div class="signal-label">Expected Change</div>
                    <div class="signal-value">${data.pct_change > 0 ? '+' : ''}${data.pct_change}%</div>
                </div>
                <div class="signal-item">
                    <div class="signal-label">Confidence</div>
                    <div class="signal-value">${data.confidence}%</div>
                </div>
            `;
            
            // Display summary
            document.getElementById('summary').innerHTML = data.summary;
            
            // Display chart
            displayChart(data.chart);
        }

        // ========================================
        // DISPLAY CHART (TASK 41: With EMA Overlays)
        // ========================================
        function displayChart(chartData) {
            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
            }
            
            const ctx = document.getElementById('predChart').getContext('2d');
            
            // Build datasets array with price and prediction
            const datasets = [
                {
                    label: 'Historical Price',
                    data: chartData.prices,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true,
                    order: 1
                },
                {
                    label: 'Predicted Price',
                    data: chartData.prediction,
                    borderColor: '#ef4444',
                    borderDash: [10, 5],
                    borderWidth: 3,
                    pointRadius: 5,
                    pointBackgroundColor: '#ef4444',
                    fill: false,
                    order: 0
                }
            ];
            
            // TASK 41: Add EMA overlays if available
            // EMAs react faster to price changes than SMAs
            // Multiple EMAs show trend structure clearly
            if (chartData.ema9) {
                datasets.push(
                    {
                        label: 'EMA 9',
                        data: chartData.ema9,
                        borderColor: '#10b981',
                        borderWidth: 1.5,
                        borderDash: [2, 2],
                        pointRadius: 0,
                        fill: false,
                        order: 2
                    },
                    {
                        label: 'EMA 20',
                        data: chartData.ema20,
                        borderColor: '#06b6d4',
                        borderWidth: 1.5,
                        borderDash: [2, 2],
                        pointRadius: 0,
                        fill: false,
                        order: 2
                    },
                    {
                        label: 'EMA 50',
                        data: chartData.ema50,
                        borderColor: '#f59e0b',
                        borderWidth: 1.5,
                        borderDash: [4, 2],
                        pointRadius: 0,
                        fill: false,
                        order: 2
                    },
                    {
                        label: 'EMA 100',
                        data: chartData.ema100,
                        borderColor: '#a855f7',
                        borderWidth: 1.5,
                        borderDash: [4, 2],
                        pointRadius: 0,
                        fill: false,
                        order: 2
                    },
                    {
                        label: 'EMA 200',
                        data: chartData.ema200,
                        borderColor: '#ec4899',
                        borderWidth: 2,
                        borderDash: [5, 3],
                        pointRadius: 0,
                        fill: false,
                        order: 2
                    }
                );
            }
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.timestamps,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ========================================
        // LOAD PREDICTION HISTORY
        // ========================================
        async function loadHistory() {
            try {
                const response = await fetch('/api/prediction_history');
                const data = await response.json();
                
                if (data.success) {
                    displayHistory(data.predictions);
                }
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }

        function displayHistory(predictions) {
            const table = document.getElementById('historyTable');
            
            let html = `
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Mode</th>
                        <th>Signal</th>
                        <th>Current Price</th>
                        <th>Target Price</th>
                        <th>Confidence</th>
                        <th>Change</th>
                        <th>Outcome</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            predictions.forEach(pred => {
                const modeClass = pred.mode === 'ai' ? 'badge-ai' : 'badge-indicator';
                const signalEmoji = pred.signal === 'BUY' ? 'üü¢' : (pred.signal === 'SELL' ? 'üî¥' : 'üü°');
                const outcomeEmoji = pred.outcome === 'correct' ? '‚úÖ' : (pred.outcome === 'incorrect' ? '‚ùå' : '‚è≥');
                
                html += `
                    <tr>
                        <td>${new Date(pred.created_at).toLocaleString()}</td>
                        <td>${pred.symbol}</td>
                        <td><span class="badge ${modeClass}">${pred.mode.toUpperCase()}</span></td>
                        <td>${signalEmoji} ${pred.signal}</td>
                        <td>$${pred.current_price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>$${pred.target_price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${pred.confidence}%</td>
                        <td>${pred.pct_change > 0 ? '+' : ''}${pred.pct_change}%</td>
                        <td>${outcomeEmoji}</td>
                    </tr>
                `;
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }

        // ========================================
        // LOAD EXCHANGE ACCOUNTS
        // ========================================
        async function loadExchangeAccounts() {
            try {
                const response = await fetch('/api/exchange/accounts');
                const data = await response.json();
                
                const select = document.getElementById('advExchangeAccount');
                select.innerHTML = '<option value="">Select an exchange account...</option>';
                
                if (data.success && data.accounts && data.accounts.length > 0) {
                    data.accounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.id;
                        option.textContent = `${account.exchange_name} - ${account.account_label || 'Account #' + account.id}${account.is_testnet ? ' (Testnet)' : ''}`;
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No exchange accounts linked. Please add one in Profile.';
                    option.disabled = true;
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Failed to load exchange accounts:', error);
            }
        }

        // ========================================
        // EXECUTE ADVANCED TRADE
        // ========================================
        async function executeAdvancedTrade() {
            console.log('='.repeat(70));
            console.log('EXECUTE ADVANCED TRADE - Starting...');
            console.log('='.repeat(70));
            
            // Get form values
            const exchangeAccountId = document.getElementById('advExchangeAccount').value;
            const symbol = document.getElementById('symbol').value;
            const timeframe = document.getElementById('timeframe').value;
            const mode = selectedMode;
            const amountUsdt = parseFloat(document.getElementById('advAmountUsdt').value);
            
            console.log('Parameters:');
            console.log(`  Exchange Account ID: ${exchangeAccountId}`);
            console.log(`  Symbol: ${symbol}`);
            console.log(`  Timeframe: ${timeframe}`);
            console.log(`  Mode: ${mode}`);
            console.log(`  Amount (USDT): $${amountUsdt}`);
            
            // Validate inputs
            if (!exchangeAccountId) {
                alert('‚ö†Ô∏è Please select an exchange account first!');
                return;
            }
            
            if (!amountUsdt || amountUsdt < 10) {
                alert('‚ö†Ô∏è Please enter an amount of at least $10 USDT');
                return;
            }
            
            // Get button and result div
            const btn = document.getElementById('executeAdvancedTradeBtn');
            const resultDiv = document.getElementById('advancedTradeResult');
            
            // Show loading state
            btn.disabled = true;
            btn.textContent = '‚è≥ Analyzing & Executing...';
            resultDiv.innerHTML = `
                <div style="background: #dbeafe; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <p style="color: #1e40af; margin: 0;">
                        ‚è≥ Running ${mode.toUpperCase()} prediction and executing trade...
                    </p>
                </div>
            `;
            
            try {
                console.log('[1] Sending request to /api/advanced_ai_trade...');
                
                // Send request to backend
                const response = await fetch('/api/advanced_ai_trade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        exchange_account_id: parseInt(exchangeAccountId),
                        symbol: symbol,
                        timeframe: timeframe,
                        mode: mode,
                        amount_usdt: amountUsdt
                    })
                });
                
                const data = await response.json();
                console.log('[2] Response received:', data);
                
                // ========================================
                // HANDLE RESPONSE
                // ========================================
                if (data.executed === false && data.reason) {
                    // HOLD signal - no trade executed
                    console.log('[3] Result: HOLD signal - No trade executed');
                    
                    resultDiv.innerHTML = `
                        <div style="background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <h4 style="color: #92400e; margin-top: 0;">
                                üü° HOLD Signal - No Trade Executed
                            </h4>
                            <p style="color: #78350f; margin: 10px 0;">
                                <strong>Reason:</strong> ${data.reason}
                            </p>
                            <p style="color: #78350f; margin: 10px 0;">
                                <strong>Mode:</strong> ${data.prediction?.mode?.toUpperCase() || mode.toUpperCase()}
                            </p>
                            <p style="color: #78350f; margin: 10px 0;">
                                <strong>Confidence:</strong> ${data.prediction?.confidence || 'N/A'}%
                            </p>
                            <p style="color: #6b7280; font-size: 0.9em; margin: 15px 0 0 0;">
                                üí° <em>The prediction model suggests holding your current position. No order was placed.</em>
                            </p>
                        </div>
                    `;
                } else if (data.executed && data.success) {
                    // Trade executed successfully
                    console.log('[3] Result: Trade executed successfully!');
                    
                    const sideColor = data.side === 'buy' ? '#10b981' : '#ef4444';
                    const sideEmoji = data.side === 'buy' ? 'üü¢' : 'üî¥';
                    const modeText = data.mode === 'SIMULATED' ? 'üéÆ SIMULATED' : 'üî¥ LIVE';
                    
                    resultDiv.innerHTML = `
                        <div style="background: ${data.side === 'buy' ? '#d1fae5' : '#fee2e2'}; padding: 20px; border-radius: 8px; border-left: 4px solid ${sideColor};">
                            <h4 style="color: ${data.side === 'buy' ? '#065f46' : '#991b1b'}; margin-top: 0;">
                                ${sideEmoji} Trade Executed: ${data.side.toUpperCase()}
                            </h4>
                            
                            <div style="background: white; padding: 15px; border-radius: 6px; margin: 15px 0;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; font-weight: 600; color: #374151;">Mode:</td>
                                        <td style="padding: 8px; color: #6b7280;">
                                            ${modeText}
                                            ${data.live_mode ? '<strong style="color: #dc2626;">‚ö†Ô∏è REAL MONEY</strong>' : '<span style="color: #059669;">‚úÖ Safe Demo</span>'}
                                        </td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; font-weight: 600; color: #374151;">Side:</td>
                                        <td style="padding: 8px; color: ${sideColor}; font-weight: bold;">${data.side.toUpperCase()}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; font-weight: 600; color: #374151;">Symbol:</td>
                                        <td style="padding: 8px; color: #6b7280;">${symbol}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; font-weight: 600; color: #374151;">Amount:</td>
                                        <td style="padding: 8px; color: #6b7280;">
                                            ${data.amount_base?.toFixed(8)} ${symbol.split('/')[0]} 
                                            <span style="color: #9ca3af;">(~$${data.amount_usdt})</span>
                                        </td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; font-weight: 600; color: #374151;">Price:</td>
                                        <td style="padding: 8px; color: #6b7280;">$${data.current_price?.toLocaleString()}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; font-weight: 600; color: #374151;">Prediction Signal:</td>
                                        <td style="padding: 8px; color: ${sideColor}; font-weight: bold;">${data.signal}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px; font-weight: 600; color: #374151;">Confidence:</td>
                                        <td style="padding: 8px; color: #6b7280;">${data.confidence}%</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; font-weight: 600; color: #374151;">Target Price:</td>
                                        <td style="padding: 8px; color: #6b7280;">$${data.target_price?.toLocaleString()}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <p style="color: ${data.side === 'buy' ? '#065f46' : '#991b1b'}; margin: 10px 0; font-weight: 500;">
                                ${data.message || 'Trade executed based on advanced prediction'}
                            </p>
                            
                            ${!data.live_mode ? `
                                <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-top: 15px;">
                                    <p style="color: #78350f; font-size: 0.9em; margin: 0;">
                                        ‚ÑπÔ∏è <strong>Simulation Mode:</strong> This trade was logged but not sent to the exchange. 
                                        To enable live trading, set <code>LIVE_TRADING_ENABLED = True</code> in config.py 
                                        (NOT recommended for university projects).
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    // Optionally refresh prediction display if needed
                    // displayResults(data.prediction);
                    
                } else {
                    // Error occurred
                    console.error('[3] Result: Error occurred:', data.error);
                    
                    resultDiv.innerHTML = `
                        <div style="background: #fee2e2; padding: 20px; border-radius: 8px; border-left: 4px solid #dc2626;">
                            <h4 style="color: #991b1b; margin-top: 0;">
                                ‚ùå Trade Execution Failed
                            </h4>
                            <p style="color: #7f1d1d; margin: 10px 0;">
                                <strong>Error:</strong> ${data.error || 'Unknown error occurred'}
                            </p>
                            <p style="color: #6b7280; font-size: 0.9em; margin: 15px 0 0 0;">
                                üí° Check the browser console for more details.
                            </p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('[ERROR] Failed to execute advanced trade:', error);
                
                resultDiv.innerHTML = `
                    <div style="background: #fee2e2; padding: 20px; border-radius: 8px; border-left: 4px solid #dc2626;">
                        <h4 style="color: #991b1b; margin-top: 0;">
                            ‚ùå Request Failed
                        </h4>
                        <p style="color: #7f1d1d; margin: 10px 0;">
                            <strong>Error:</strong> ${error.message}
                        </p>
                        <p style="color: #6b7280; font-size: 0.9em; margin: 15px 0 0 0;">
                            üí° Please check your network connection and try again.
                        </p>
                    </div>
                `;
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.textContent = '‚ö° Execute Advanced Trade';
                
                console.log('='.repeat(70));
                console.log('EXECUTE ADVANCED TRADE - Complete');
                console.log('='.repeat(70));
            }
        }

        // ========================================
        // PAGE INITIALIZATION
        // ========================================
        // Load history and exchange accounts on page load
        window.addEventListener('load', function() {
            console.log('Advanced Prediction page loaded');
            
            // Load prediction history
            loadHistory();
            
            // Load exchange accounts for trade execution
            loadExchangeAccounts();
            
            // Add event listener to execute trade button
            const executeBtn = document.getElementById('executeAdvancedTradeBtn');
            if (executeBtn) {
                executeBtn.addEventListener('click', executeAdvancedTrade);
                console.log('‚úì Execute trade button listener attached');
            }
        });
    </script>
</body>
</html>

